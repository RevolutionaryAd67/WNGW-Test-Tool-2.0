{% import 'input-box/input_box.html' as input_box_component %}
{% extends "base.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pruefungseinstellungen.css') }}">
    <link rel="stylesheet" href="{{ url_for('component_asset', filename='input-box/input_box.css') }}">
{% endblock %}

{% block content %}
<section class="exam-settings">
    <div class="exam-settings__box">
        <header class="exam-settings__header">
            <div>
                <h2 class="exam-settings__title">Excel-Tabellen hinterlegen</h2>
            </div>
            <div class="exam-settings__actions">
                <span class="exam-settings__status" id="exam-settings-status" aria-live="polite"></span>
                <button type="button" class="exam-settings__save" id="exam-settings-save">Speichern</button>
            </div>
        </header>

        <div class="exam-settings__table-wrapper">
            <table class="exam-settings__table">
                <thead>
                    <tr>
                        <th scope="col">Objekt</th>
                        <th scope="col">Hochladen</th>
                        <th scope="col">Datei</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row">Datenpunktliste</th>
                        <td>
                            <label class="file-input">
                                <input type="file" id="exam-settings-file" accept=".xlsx">
                                <span id="exam-settings-file-label">Excel-Datei auswählen</span>
                            </label>
                        </td>
                        <td><span id="exam-settings-file-name">–</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p class="exam-settings__note">
            Vollständige Datenpunktliste (Signalliste) des WNGW hinterlegen. Diese Datenpunktliste dient zur Prüfung des WNGW. Außerdem
            werden mithilfe dieser Datenpunktliste den eingehenden Telegrammen Meldetexte zugeordnet, sodass Telegramme durch den Benutzer
            identifiziert werden können.
        </p>
    </div>

    {% set columns = [
        {"key": "parameter", "label": "Parameter", "type": "header"},
        {"key": "value", "label": "Wert", "type": "input", "input_type": "number", "placeholder": "z. B. 60"}
    ] %}

    {% set rows = [
        {"id": "zeit_zwischen_pruefungen", "label": "Zeit zwischen Teilprüfungen [s]"},
        {"id": "wartezeit_telegramme_ms", "label": "Wartezeit auf eingehende Telegramme [ms]"}
    ] %}

    {% set stored_values = input_box_values("einstellungen_pruefungseinstellungen", "pruefungssteuerung", columns, rows) %}
    {% if not stored_values.get('zeit_zwischen_pruefungen') %}
        {% set _ = stored_values.update({'zeit_zwischen_pruefungen': {'value': default_pause_between_tests|int}}) %}
    {% elif stored_values.get('zeit_zwischen_pruefungen').get('value') == '' %}
        {% set _ = stored_values['zeit_zwischen_pruefungen'].update({'value': default_pause_between_tests|int}) %}
    {% endif %}
    {% if not stored_values.get('wartezeit_telegramme_ms') %}
        {% set _ = stored_values.update({'wartezeit_telegramme_ms': {'value': default_incoming_telegram_timeout_ms|int}}) %}
    {% elif stored_values.get('wartezeit_telegramme_ms').get('value') == '' %}
        {% set _ = stored_values['wartezeit_telegramme_ms'].update({'value': default_incoming_telegram_timeout_ms|int}) %}
    {% endif %}

    {% set pruefungssteuerung_box = {
        "id": "pruefungssteuerung",
        "page_key": "einstellungen_pruefungseinstellungen",
        "title": "Prüfungssteuerung",
        "note": "Für die Zeit zwischen Prüfungen sollte mindestens 60 Sekunden gewählt werden, um eine vollständige Weiterleitung der Signale durch das WNGW zu garantieren (Das WNGW leitet z.B. nur alle 30 Sekunden eine GENERALABFRAGE ACT weiter).<br><br>Mit der \"Wartezeit auf eingehende Telegramme\" ist die Zeit gewartet, die der Teilnehmer auf die Durchleitung eines Signals durch das WNGW wartet, bis dieser Teilnehmer automatisch mit seinen Quellsignalen fortfährt. Eine Zeit von 5000 ms (5 s) scheint in ersten Tests gute Ergebnisse zu erzielen.",
        "table": {
            "columns": columns,
            "rows": rows
        },
        "values": stored_values
    } %}

    {{ input_box_component.render(pruefungssteuerung_box) }}
</section>
{% endblock %}

{% block extra_js %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/pruefungseinstellungen.js') }}" defer></script>
    <script src="{{ url_for('component_asset', filename='input-box/input_box.js') }}" defer></script>
{% endblock %}
